{"ast":null,"code":"var path = require('path');\nvar J = require('jski')();\nvar walk = require('walk-fs');\nvar Q = require('kew');\nfunction camelize(str) {\n  return str.replace(/(^\\w)|(\\-\\w)/g, function (m) {\n    return m.slice(-1).toUpperCase();\n  });\n}\n;\nfunction extend(a, b) {\n  for (var x in b) a[x] = b[x];\n  return a;\n}\n;\nmodule.exports = function loadResources(cores, dir, context, syncDesign) {\n  var defer = Q.defer();\n  if (!dir) {\n    return Q.resolve({});\n  }\n  dir = path.resolve(dir);\n  var configs = {};\n  var re = /\\/([^_][\\w\\-]+)-(schema|design)\\.js$/i;\n  walk(dir, {\n    recursive: true\n  }, function (path, stats) {\n    if (stats.isFile()) {\n      var parts = path.match(re);\n      if (parts) {\n        var name = parts[1].toLowerCase();\n        var type = parts[2].toLowerCase();\n        var cname = camelize(name);\n        var config = configs[cname] = configs[cname] || {};\n        var def = require(path);\n        // when required module is a function, execute it with context\n        if (typeof def === 'function') {\n          def = def(context);\n        }\n        // convert pure json schemas to jski schemas\n        if (type === 'schema' && !def.__jski__) {\n          def = J.createValidator(def);\n        }\n        config[type] = def;\n      }\n    }\n  }, function (err) {\n    if (err) return defer.reject(err);\n    var keys = Object.keys(configs);\n    var numRes = keys.length;\n    var resources = {};\n    var promises = Object.keys(configs).map(function (name) {\n      var config = configs[name];\n      config.validateRefs = false;\n      return cores.create(name, config, syncDesign).then(function (res) {\n        resources[name] = res;\n      });\n    });\n    Q.all(promises).then(function () {\n      defer.resolve(resources);\n    }, function (err) {\n      defer.reject(err);\n    });\n  });\n  return defer.promise;\n};","map":{"version":3,"names":["path","require","J","walk","Q","camelize","str","replace","m","slice","toUpperCase","extend","a","b","x","module","exports","loadResources","cores","dir","context","syncDesign","defer","resolve","configs","re","recursive","stats","isFile","parts","match","name","toLowerCase","type","cname","config","def","__jski__","createValidator","err","reject","keys","Object","numRes","length","resources","promises","map","validateRefs","create","then","res","all","promise"],"sources":["C:/game/mern/node_modules/cores/lib/load-resources.js"],"sourcesContent":["var path = require('path');\nvar J = require('jski')();\nvar walk = require('walk-fs');\nvar Q = require('kew');\n\n\nfunction camelize(str) {\n  return str.replace(/(^\\w)|(\\-\\w)/g, function(m) {\n    return m.slice(-1).toUpperCase();\n  });\n};\n\n\nfunction extend(a, b) {\n  for (var x in b) a[x] = b[x];\n  return a;\n};\n\n\nmodule.exports = function loadResources(cores, dir, context, syncDesign) {\n\n  var defer = Q.defer();\n  if (!dir) {\n    return Q.resolve({});\n  }\n\n  dir = path.resolve(dir);\n\n  var configs = {};\n  var re = /\\/([^_][\\w\\-]+)-(schema|design)\\.js$/i;\n\n  walk(dir, { recursive: true }, function(path, stats) {\n\n    if (stats.isFile()) {\n      var parts = path.match(re);\n\n      if (parts) {\n        var name = parts[1].toLowerCase();\n        var type = parts[2].toLowerCase();\n        var cname = camelize(name);\n        var config = configs[cname] = configs[cname] || {};\n\n        var def = require(path);\n        // when required module is a function, execute it with context\n        if (typeof def === 'function') {\n          def = def(context);\n        }\n        // convert pure json schemas to jski schemas\n        if (type === 'schema' && !def.__jski__) {\n          def = J.createValidator(def);\n        }\n        config[type] = def;\n      }\n    }\n  }, function(err) {\n    if (err) return defer.reject(err);\n\n    var keys = Object.keys(configs);\n    var numRes = keys.length;\n    var resources = {};\n\n    var promises = Object.keys(configs).map(function(name) {\n\n      var config = configs[name];\n      config.validateRefs = false;\n      return cores.create(name, config, syncDesign).then(function(res) {\n        resources[name] = res;\n      });\n    });\n\n    Q.all(promises).then(function() {\n      defer.resolve(resources);\n    }, function(err) {\n      defer.reject(err);\n    });\n  });\n\n  return defer.promise;\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}